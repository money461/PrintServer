<body>
	<!-- 订阅窗口 -->
	<div id="subscribeDialog" style="display: none;">
		<div id="sr">
			<div class="easyui-panel" title="新增主单号订阅" style="width: 100%">
				<form id="srForm" method="post" class="form-horizontal center-vertical" action="../../subscribe/add">
					<div class="col-md-3 col-xs-6" style="padding: 5px 0">
						<label for="srMawb" class="col-md-3 control-label" title="MAWB">MAWB:</label>
						<div class="col-md-9">
							<textarea rows="1" class="form-control easyui-validatebox" data-options="required:true" name="srMawb" id="srMawb" style="height: 34px;"></textarea>
						</div>
					</div>
					<div class="col-md-3 col-xs-6" style="padding: 5px 0">
						<label for="srHawb" class="col-md-3 control-label" title="MAWB">HAWB:</label>
						<div class="col-md-9">
							<textarea rows="1" class="form-control" name="srHawb" id="srHawb" style="height: 34px;"></textarea>
						</div>
					</div>
					<div class="col-md-3 col-xs-6" style="padding: 5px 0">
						<label for="srEmail" class="col-md-3 control-label" title="Email">Email:</label>
						<div class="col-md-9">
							<input class="form-control" name="srEmail" id="srEmail" th:value="${session.userInfo.email}" disabled="disabled"></input>
						</div>
					</div>
					<div class="col-md-3 col-xs-6" style="padding: 5px 0">
						<label for="srUser" class="col-md-3 control-label" title="MAWB">订阅人:</label>
						<div class="col-md-9">
							<input class="form-control" name="srUser" id="srUser" th:value="${session.userInfo.psnname}" disabled="disabled"></input> <input type="text" id="srOpid" th:value="${session.thisOpid}" style="display: none;">
						</div>
					</div>
				</form>
				<div style="text-align: center; padding: 5px 0">
					<button class="btn btn-primary" onclick="subscribe.submitForm()" style="width: 80px; background-color: #ec971f; color: #fff;">订阅</button>
					<button class="btn btn-primary" onclick="subscribe.clearForm()" style="width: 80px; background-color: #5bc0de; color: #fff;">重置表单</button>
				</div>
			</div>
		</div>
		<div style="height: 100%; width: 100%;">
			<table id="srDg"></table>
		</div>
	</div>

	<div id="aa" style="width: 100%">
		<div class="btn-group" style="float: right; background-color: #F5F5F5; width: 100%;">
			<button type="button" class="btn btn-default" onclick="label.search();">
				<span class="glyphicon glyphicon-search"></span> 查询(ctrl+1)
			</button>
			<button type="button" class="btn btn-default" onclick="label.print1()">
				<span class="glyphicon glyphicon-print"></span> 打印
			</button>
			<button type="button" class="btn btn-default" onclick="label.export1()">
				<span class="glyphicon glyphicon-share"></span> 导出标签
			</button>
			<button type="button" class="btn btn-default" onclick="label.delete1();">
				<span class="glyphicon glyphicon-remove"></span> 删除
			</button>
			<button type="button" class="btn btn-default" onclick="label.refresh(true)">
				<span class="glyphicon glyphicon-refresh"></span> 刷新表单
			</button>
			<button type="button" class="btn btn-default" onclick="subscribe.initWindow()">
				<span class="glyphicon glyphicon-envelope"></span> 订阅
			</button>
			<button type="button" class="btn btn-default" onclick="alert('')">
				<span class="glyphicon glyphicon-bell"></span> 帮助
			</button>
			<button type="button" class="btn btn-default" onclick="label.print2()">
				<span class="glyphicon glyphicon-map-marker"></span> <b style="color: green; font-size: 14" id="quyu">更改打印区域</b>
			</button>
		</div>
		<form id='searchForm' class="form-horizontal center-vertical" role="form">
			<table id="medicine" style="width: 100%;">
				<tr>
					<td style="text-align: right;">发货日期:</td>
					<td><input type="text" id="start_time" name="start_time">-<input type="text" id="end_time" name="end_time"></td>
					<td style="text-align: right;">运单号:</td>
					<td><textarea rows="1" class="easyui-textbox" data-options="multiline:true" name="MBLNo" id="MBLNo"></textarea></td>
					<td style="text-align: right;">随货同行单号:</td>
					<td><textarea rows="1" class="easyui-textbox" data-options="multiline:true" name="TakeCargoNo" id="TakeCargoNo"></textarea></td>
					<td style="text-align: right;">是否打印:</td>
					<td><select id="status" name="status" class="easyui-combobox" style="width: 141px;">
							<option value=""></option>
							<option value="0" selected="selected">未打印</option>
							<option value="1">已打印</option>
					</select></td>
				</tr>
			</table>
			<table id="air" style="width: 100%;">
				<tr>
					<td style="text-align: right;">录入时间:</td>
					<td><input type="text" id="start_time" name="start_time">-<input type="text" id="end_time" name="end_time"></td>
					<td style="text-align: right;">航班日期:</td>
					<td><input id="flight_date" type="text" name="flight_date"></input></td>
					<td style="text-align: right;">MAWB:</td>
					<td><textarea rows="1" class="easyui-textbox" data-options="multiline:true" name="mawb" id="mawb"></textarea></td>
					<td style="text-align: right;">HAWB:</td>
					<td><input type="text" id="hawb" class="easyui-textbox" name="hawb" maxlength="13"></td>
					<td style="text-align: right;">件数:</td>
					<td><input type="number" class="easyui-numberbox" id="total" name="total"></td>
				</tr>
				<tr>
					<td style="text-align: right;">起始地:</td>
					<td><input type="text" id="airport_departure" name="airport_departure" /></td>
					<td style="text-align: right;">目的地:</td>
					<td><input type="text" id="destination" name="destination" /></td>
					<td style="text-align: right;">是否打印:</td>
					<td><select id="status" name="status" class="easyui-combobox" style="width: 141px;">
							<option value=""></option>
							<option value="0" selected="selected">未打印</option>
							<option value="1">已打印</option>
					</select></td>
					<td style="text-align: right;">录入人:</td>
					<td><input type="text" id="opid_name" name="opid_name" maxlength="15" /></td>
				</tr>
			</table>
		</form>
	</div>
	<div style="height: 100%; width: 100%;">
		<table id="dg1"></table>
	</div>

	<div id="region" style="display: none; margin-top: 20px;">
		<blockquote class="text-success" style="display: none;" id="bqys">
			选择标签样式 <select id="selectbq" class="form-control" style="height: 50px;">
			</select>
		</blockquote>
		<blockquote class="text-success" style="display: none; width: 100%;" id="xzdy">
			设置打印办公室
			<p style="display: none;" id="bgs">
				<input type="radio" value="mr" name="bgs">默认办公室 <input type="radio" value="ls" name="bgs">临时办公室
			</p>
			<input id="cc" style="width: 100%; height: 50px;"> <input type="text" style="display: none;" id="code">
		</blockquote>
		<!-- 	<blockquote class="text-success" style="display: none; width: 100%" id="ssdy">
		搜索打印办公室<input id="cc1" name="dept" style="width: 100%; height: 50px;" />
	</blockquote> -->
		<div class="form-group col-md-12 col-sm-10" style="display: none;" id="dyan">
			<button type="button" class="btn btn-info btn-lg btn-block" onclick="label.print()">打印</button>
		</div>
		<div class="form-group col-md-12 col-sm-10" style="display: none;" id="dcan">
			<button type="button" class="btn btn-info btn-lg btn-block" onclick="label.export()">导出</button>
		</div>
		<div class="form-group col-md-12 col-sm-10" style="display: none;" id="xgmr">
			<button type="button" class="btn btn-info btn-lg btn-block" onclick="label.update3()">更改</button>
		</div>
	</div>
	<div id="dd2"></div>
	<div id="dd4" style="display: none; padding: 15px;">
		<form class="form-horizontal" role="form" style="margin-top: 20px;" id="updateform" action="/labelPrint/label/update">
			<input type="text" hidden="true" id="label_id" name="label_id">
			<div class="form-group  has-success col-sm-6">
				<label class="col-sm-2 control-label">MAWB:</label>
				<div class="col-sm-10">
					<input class="form-control" id="MAWB1" name="mawb" disabled="disabled" type="text">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label for="inputPassword" class="col-sm-2 control-label"> HAWB: </label>
				<div class="col-sm-10">
					<input class="form-control" id="HAWB1" name="hawb" type="text" maxlength="13">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label for="disabledTextInput" class="col-sm-2 control-label">件数: </label>
				<div class="col-sm-10">
					<input class="form-control" id="total1" type="text" name="total" disabled="disabled">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label for="disabledSelect" class="col-sm-2 control-label">起始地: </label>
				<div class="col-sm-10">
					<input class="form-control" id="airport_departure1" type="text" name="airport_departure" disabled="disabled">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label class="col-sm-2 control-label" for="inputSuccess">目的地:</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" id="destination1" name="destination" disabled="disabled">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label class="col-sm-2 control-label" for="inputWarning">状态:</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" id="is_print1" name="is_print" disabled="disabled">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label class="col-sm-2 control-label" for="inputWarning">入库时间:</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" id="create_time" name="create_time" disabled="disabled">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label class="col-sm-2 control-label" for="inputWarning">打印时间 :</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" id="reserve2" name="reserve2" disabled="disabled">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label class="col-sm-2 control-label" for="inputWarning">航班日期 :</label>
				<div class="col-sm-10">
					<!-- <input type="text" class="form-control" id="flight_date" name="flight_date" disabled="disabled"> -->
					<input type="text" class="form-control" name="flight_date" disabled="disabled">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label class="col-sm-2 control-label" for="inputWarning">打印人 :</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" id="print_user" name="print_user" disabled="disabled">
				</div>
			</div>
			<div class="form-group has-success col-sm-6">
				<label class="col-sm-2 control-label" for="inputWarning">当前模版:</label>
				<div class="col-sm-10">
					<input id="reserve3" name="reserve3" style="width: 100%;">
				</div>
			</div>
			<div class="form-group col-md-12 col-sm-10">
				<button type="button" class="btn btn-info btn-lg btn-block" onclick="label.update()">保存</button>
			</div>
		</form>
	</div>
	<script th:inline="javascript">
	$(function () {
		var opid1 =  [[${session.thisOpid}]];
	    var buttons = $.extend([], $.fn.datetimebox.defaults.buttons);
	    buttons.splice(2, 0, {
	    	text: '清空',
	    	handler: function(target){
	    		$(target).datebox('setValue','');
	    	}
	    });
	    var buttons1 = $.extend([], $.fn.datebox.defaults.buttons);
	    buttons1.splice(1, 0, {
	    	text: '清空',
	    	handler: function(target){
	    		$(target).datebox('setValue','');
	    	}
	    });
	
		$(document).ready(function(){
			  $("body").keydown(function(){
				  if (event.keyCode == 49&&event.ctrlKey) {  
					  label.search();
		          } 
			  });
		});
		$("form :input[type='text']").change(function(){
			if ($(this).val()!="") {
				$(this).css('background-color','#FFFFBB');
			}else {
				$(this).css('background-color','white');
			}
		});
		$("form :input[type='text']").focus(function(){
			if ($(this).val()!="") {
				$(this).select();
			}
		})
	
		$('#flight_date').datebox({
			editable:false,
			buttons:buttons1
		});	
		$('#start_time').datetimebox({  
			width:72,
		    required : false,  
		    editable:false,
		    buttons:buttons,
		    onShowPanel:function(){  
		        $(this).datetimebox("spinner").timespinner("setValue","00:00:00");  
		    },
		    onChange: function(newValue, oldValue){
		    	label.search();
		    }  
		});
		$('#end_time').datetimebox({
			width:72,
		    required : false,  
		    editable:false,
		    buttons:buttons,
		    onShowPanel:function(){
		        $(this).datetimebox("spinner").timespinner("setValue","23:59:59");  
		    },
		    onChange: function(newValue, oldValue){
		    	label.search();
		    }   
		});
		$("#ssdy").on("mouseover",function(){
			if($("#cc").val()!="选择办公区域"){
				$("#ssdy").fadeOut(1000);
			}
		})
		$.ajax({
			url : "/labelPrint/client/getThisRegion?opid="+opid1+"&code="+localStorage.getItem('ls'),
			type : 'POST',
			async:false,
			success : function(result) {
				var	rt = eval("("+result+")");
				$("#quyu").text(rt.parent_name+'/'+rt.region_name);
			}
		});
	
	/* 	$("#xzdy").on("mouseover",function(){
			if($("#cc1").val()!=""){
				$("#xzdy").fadeOut(1000);
			}
		}) */
		
	/* 	$('#status').bootstrapSwitch({
			onText : "是",
			offText : "否",
			onColor : "success",
			offColor : "info",
			size : "small",
			onSwitchChange:function (e, data) {
				label.search(); 
			}
		}) */
		
	
		
	});
	function setName(){
		$.ajax({
			url : "/labelPrint/client/getThisRegion?opid="+opid1+"&code="+localStorage.getItem('ls'),
			type : 'POST',
			success : function(result) {
				var	rt = eval("("+result+")");
				$("#quyu").text(rt.parent_name+'/'+rt.region_name);
			}
		});
	}
	/*
	* 关闭遮罩层
	*/
	function closemask() { 
		$("#Loading").fadeOut("normal", function () { 
			$(this).remove(); 
		}); 
	} 
	var pc; 
	$.parser.onComplete = function () { 
	if (pc){
		clearTimeout(pc);
	} 
		pc = setTimeout(closemask, 10); 
	}
	
	
	function label() {
	}
	var mawb="";
	var hawb="";
	var destination="";// 目的地
	var total="";// 件数
	var airport_departure="";// 起始地
	var is_print="";// 是否打印
	var start_time;// 开始时间
	var end_time;// 结束时间
	var flight_date="";// 结束时间
	var opid_name="";// 录入人
	var MBLNo="";//
	var TakeCargoNo="";// 
	var opid;
	var opid1;

	$(function(){
		$.ajax({
			url : "../../labelPrint/getThisOpids",
			type : 'POST',
			async:false,
			success : function(result) {// 根据结果显示菜单
				opid1= result;
			}
		});
		$.ajax({
			url : "/labelPrint/client/getPrint",
			type : 'POST',
			async:false,
			success : function(result) {
				opid = eval('(' + result + ')');
			}
		});
		
		/*
		 * $("label").click(function(){ alert($(this).attr("title")); });
		 */

		$('#opid_name').combogrid({    
			idField:'opid_name',    
			textField:'opid_name',    
			mode:'remote',
			value:'所有',    
			height:34,
			fitColumns:true,
			scrollbarSize : 0,
			url:'/labelPrint/client/getOpidName',    
			columns:[[
					{field:'opid_name',title:'',width:50},
					{field:'opid',title:'',width:50}
				]],
			onSelect:function(rowIndex, rowData){
					opid_name =rowData.opid_name; 
				}
		}); 
		
		$('#airport_departure').combogrid({    
		    idField:'code',    
		    textField:'name',    
		    mode:'remote',
		    value:'所有',    
		    height:34,
		    fitColumns:true,
		    scrollbarSize : 0,
		    url:'/labelPrint/client/getRegion',    
		    columns:[[    
		        {field:'name',title:'',width:50}
		    ]],
		    onSelect:function(rowIndex, rowData){
		    	airport_departure =rowData.code; 
		    }
		});  
		$('#destination').combogrid({    
			idField:'code',    
			textField:'name',
			mode:'remote',
			value:'所有',
			height:34,
			fitColumns:true,
			scrollbarSize : 0,
			url:'/labelPrint/client/getRegion',    
			columns:[[    
				{field:'name',title:'',width:50}
				]],
			onSelect:function(rowIndex, rowData){
				destination =rowData.code; 
		    }
		});  
		label.initLabelDatagrid();
	}); 

	function formatDate(time){
		if (time!=undefined&&undefined!="undefined") {
		    var date = new Date(time);
		    var year = date.getFullYear(),
		        month = date.getMonth()+1,// 月份是从0开始的
		        day = date.getDate(),
		        hour = date.getHours(),
		        min = date.getMinutes(),
		        sec = date.getSeconds();
		    var newTime = year + '-' +
		                (month < 10? '0' + month : month) + '-' +
		                (day < 10? '0' + day : day) + ' ' +
		                (hour < 10? '0' + hour : hour) + ':' +
		                (min < 10? '0' + min : min) + ':' +
		                (sec < 10? '0' + sec : sec);
	
		    return newTime;
		}else{
		    return null;         
		}
	}

	var vda = $("#searchForm").myVdate();
	label.prototype.update = function() {
		var updateform = $("#updateform").myVdate();
		if (!updateform.startValidate()) {
			return;
		}
		$("#updateform").submit();
		// $('#dd4').dialog("close");
		// $('#dg1').datagrid("reload");
	}
	label.prototype.delete1 = function() {
		var rows = $('#dg1').datagrid('getSelections');
		if (rows.length > 0) {
			if(window.confirm('确定要删除？')){
				$.ajax({
					url : "/labelPrint/label/delete",
					type : 'POST',
					data : {
						label : JSON.stringify(rows)
					},
					success : function(result) {
						$('#dg1').datagrid('reload');
					}
				});
	            return true;
	         }else{
	            return false;
	        }
		}else {
			alert("请选择数据后再删除！");
		}
		
	}
	label.prototype.refresh = function(isRefresh) {
		$("#searchForm").form("clear");
		$("#total").val("");
		
		mawb = "";
		hawb = "";
		destination = "";// 目的地
		total = "";// 件数
		airport_departure = "";// 起始地
		is_print = "";
		start_time = "";
		end_time = "";
		flight_date= "";
		$('#airport_departure').combogrid('setValue', '所有');// 替换为所有
		$('#destination').combogrid('setValue', '所有');// 替换为所有
		$('#opid_name').combogrid('setValue', '所有');// 替换为所有
		opid_name= "";
		if (isRefresh) {
			label.initLabelDatagrid();
		}
	}
	label.prototype.search = function() {
		var mr;
		
		if (!vda.startValidate()) {
			return;
		}
		// $('#dd3').dialog('close');
		var tMawb = $.trim($("#mawb").val()) == undefined?"":$.trim($("#mawb").val());
		if (tMawb!="") {
			mawb = JSON.stringify(tMawb.split("\n"));
		}else{
			mawb = $("#mawb").val();
		}
		hawb = $("#hawb").val()== undefined?"":$("#hawb").val();
		total = $("#total").val()== undefined?"":$("#total").val();
		destination = $("#destination").val()== undefined?"":$("#destination").val();
		airport_departure = $("#airport_departure").val()== undefined?"":$("#airport_departure").val();
		start_time = $("#start_time").val();
		end_time = $("#end_time").val();
		flight_date = $("#flight_date").val()== undefined?"":$("#flight_date").val();
		opid_name = $("#opid_name").val()== undefined?"":$("#opid_name").val();
		MBLNo=$("#MBLNo").val()== undefined?"":$("#MBLNo").val()
		TakeCargoNo=$("#TakeCargoNo").val()== undefined?"":$("#TakeCargoNo").val()
		
		is_print = $("#status").val()==null?"":$("#status").val();
		/*
		 * if ($('[name="status"]').bootstrapSwitch('state')) { is_print = "1"; }
		 * else { is_print = "0"; }
		 */
		label.initLabelDatagrid();
	}
	label.prototype.print1 = function() {
		var rows = $('#dg1').datagrid('getSelections');// 获取所有选中行的数据
		// 查询是否是第一次登录
		$.ajax({
			url : "/labelPrint/client/isFrist?opid="+opid1,
			type : 'POST',
			async:false,
			success : function(result) {
					if (result=="false") {// 第一次登录
						// 获取用户选择的区域
						if (rows.length > 0) {
							$.ajax({
								url : "/labelPrint/client/getPrint",
								type : 'POST',
								success : function(result) {
									opid = eval('(' + result + ')');
									if (opid.length==0) {
										alert("你没有该功能权限，请先申请权限");
										return
									}
									if (opid[0].length > 1) {// 打印标签模版不止一个
										$("#dyan").css("display", "block");// 显示打印按钮
										$("#dcan").css("display", "none");// 隐藏导出按钮
										$("#xgmr").css("display", "none");// 隐藏按钮
										label.initSend();
										$("#xzdy").css("display", "block");
										$("#ssdy").css("display", "block");
										// $("#bqys").css("display", "block");
										$("#selectbq").children().remove();// 清理缓存
										$("#selectbq").append('<option selected="selected">请选择标签样式</option>');
										for (var i = 0; i < opid[0].length; i++) {
											$("#selectbq").append('<option value =' + opid[0][i].Reportid + ',' + opid[0][i].Reportname + '>' + opid[0][i].Reportname + '</option>');
										}
									} else {
										$("#dyan").css("display", "block");// 显示打印按钮
										$("#dcan").css("display", "none");// 隐藏导出按钮
										$("#xgmr").css("display", "none");// 隐藏按钮
										
										$("#xzdy").css("display", "block");
										$("#ssdy").css("display", "block");
										label.initSend();
									}
								}
							});
					} else {
						alert('请选择一条数据，再打印');
					}
				}else {// 不是第一次登录
					if(rows.length <= 0){
						alert('请选择一条数据，再打印');
						return;
					}
					mr = eval('(' + result + ')');
					if (localStorage.getItem("ls")!=null) {
						label.printLabelSendClient("", localStorage.getItem("ls"));
					}else {
						label.printLabelSendClient("", mr[0].office_id);
					}
				}
			}
		});
	}
	label.prototype.update3 = function() {
		var bgs = $("input[name='bgs']:checked").val();
		$("input[name='bgs']:checked").prop('checked', false);
		
		var t = $("#code").val();
		if (t!=""&&undefined!=bgs) {
			if (bgs=="ls") {
				if (typeof(Storage) !== "undefined") {
				    localStorage.setItem("ls", t);
					$('#region').dialog("close");
					$("#code").val("");
					setName();
				} else {
					alert("你的浏览器不兼容系统，建议更换谷歌浏览器");
				}
			}else if (bgs="mr") {
				$.ajax({
					url : "/labelPrint/client/updateRn?region="+t,
					type : 'POST',
					success : function(result) {
						if (result=="true") {
							alert("更改成功");
							$('#region').dialog("close");
							$("#code").val("");
							setName();
						}else{
							alert("更改失败，请联系管理员");
						}
					}
				});
			}
		}else{
			alert("请选择打印办公室，并勾选（默认）或（临时）");
		}
	}
	label.prototype.print2 = function() {
		var rows = $('#dg1').datagrid('getSelections');// 获取所有选中行的数据
			$.ajax({
				url : "/labelPrint/client/getPrint",
				type : 'POST',
				success : function(result) {
					opid = eval('(' + result + ')');
					if (opid.length==0) {
						alert("你没有该功能权限，请先申请权限");
						return
					}
					$("#xgmr").css("display", "block");
					$("#dcan").css("display", "none");// 隐藏导出按钮
					$("#dyan").css("display", "none");// 显示打印按钮
					
					
					$("#xzdy").css("display", "block");
					$("#ssdy").css("display", "block");
					label.initSend(true);
				}
			});
	}
	label.prototype.export1 = function() {
		var rows = $('#dg1').datagrid('getSelections');// 获取所有选中行的数据
		if (rows.length > 0) {
			$.ajax({
				url : "/labelPrint/client/getPrint",
				type : 'POST',
				success : function(result) {
					opid = eval('(' + result + ')');
					if (opid.length==0) {
						alert("你没有该功能权限，请先申请权限");
						return
					}
					
					$("#xzdy").css("display", "none");
					$("#ssdy").css("display", "none");
					$("#dcan").css("display", "block");// 显示导出按钮
					$("#dyan").css("display", "node");
					$("#dcan").css("display", "block");
					var ids = "";
					for (var i = 0; i < rows.length; i++) {
						if (i == (rows.length - 1)) {
							ids += "'" + rows[i].label_id + "'";
						} else {
							ids += "'" + rows[i].label_id + "',";
						}
					}
				    window.location.href = "/labelPrint/client/exportLabel?labels=" + ids+"&report="+opid[0][0].Reportid + ',' + opid[0][0].Reportname;
					
					$.messager.show({
						title : '<center style="color:red;">提示</center>',
						msg : '<center><p style="color:red;margin-top: 20px;">数据导出中，请勿刷新页面</p></center>',
						timeout : 2000,
						showType : 'show',
						style : {
							top : document.body.scrollTop + document.documentElement.scrollTop,
						}
					});
				}
			});

		} else {
			alert("请选择数据后再导出");
		}
	}

	/**
	 * 初始化 打印 按钮需要的选择控件
	 */
	label.prototype.initSend = function(isRadio) {
		// 初始化弹出框
		$('#region').dialog({
			title : ' ',
			width : 500,
			height : 250,
			maximizable : true,
			cache : false,
			modal : true,
			onClose:function(){
				try {
					$("input[name='bgs']:checked").prop('checked', false);
					$("#code").val("");
					$("#bgs").css("display","none");
				} catch (e) {
					console.info("初始化单选框失败");
				}
			},
			onBeforeOpen:function(){
				if(isRadio){
					try {
						$("#bgs").css("display","block");
					} catch (e) {
					}
				}
			}
		});
		// 初始化下拉树
		$('#cc').combotree({
			required : true,
			url : "/labelPrint/client/printLabel?opid="+opid1,
			onBeforeSelect : function(node) {
				return false
			},
			onClick : function(node) {
				if ($('#cc').tree('isLeaf', node.target)) {// 判断是否是叶子节点
					$('#cc').combotree('setValue', node.pname + "/" + node.text);
					$('#code').val(node.parent_code + "/" + node.region_code);
				} else {
					// 如果是父节点，实现点击展开/关闭节点
					if (node.state == "closed") {
						$(this).tree('expand', node.target);
						$('#cc').combotree("showPanel");
					} else {
						$(this).tree('collapse', node.target);
						$('#cc').combotree("showPanel");
					}
				}
			}
		});
		$('#cc').combotree('setValue', '选择办公区域');
	}
	label.prototype.printLabelSendClient = function(bq, t) {
		var url = "/labelPrint/client/printLabelSendClient";
		var rows = $('#dg1').datagrid('getSelections');
		$.ajax({
			url : url,
			type : 'POST',
			data : {
				labels : JSON.stringify(rows),
				regions : t,
				businessType : type,
				report : bq
			},
			success : function(result) {
				$.messager.show({
					title:'<b style="font-size:12;text-align:center;">我的消息</b>',
					msg:'<h3 style="color:green;text-align:center;">标签已发往客户端打印</h3>',
					timeout:3000,
					showType:'fade'
				});
				try {
					$('#region').dialog("close");
				} catch (e) {
					console.info("面板关闭失败");
				}
				$('#dg1').datagrid('reload');
			}
		});
	}
	label.prototype.export = function() {
		var rows = $('#dg1').datagrid('getSelections');// 获取所有选中行的数据
		var bq = $("#selectbq").val();
		var ids = "";
		for (var i = 0; i < rows.length; i++) {
			if (i == (rows.length - 1)) {
				ids += "'" + rows[i].label_id + "'";
			} else {
				ids += "'" + rows[i].label_id + "',";
			}
		}
	    window.location.href = "/labelPrint/client/exportLabel?labels=" + ids+"&report="+bq;
		
		$("#dcan").css("display", "none");// 隐藏导出按钮
		$('#region').dialog("close");
		
		$.messager.show({
			title : '<center style="color:red;">提示</center>',
			msg : '<center><p style="color:red;margin-top: 20px;">数据导出中，请勿刷新页面</p></center>',
			timeout : 2000,
			showType : 'show',
			style : {
				top : document.body.scrollTop + document.documentElement.scrollTop,
			}
		});
	}
	label.prototype.print = function() {
		var bq = $("#selectbq").val();
		var t = $("#code").val();
		if (opid[0].length > 1) {// 打印标签模版不止一个
			if (t == "") {
				alert("请先选择办公区域再打印");
				return;
			}
			label.printLabelSendClient(bq, t);
		} else {
			bq = opid[0][0].Reportid + ',' + opid[0][0].Reportname;
			if (t == "") {
				alert("请先选择办公区域再打印");
				return;
			}
			label.printLabelSendClient(bq, t);
		}

		$("#code").val("");
	}
	
	var type = $('#tt').data("type");
	label.prototype.columns = function(is_print2) {
		var columns;
		if (type =="air") {
			columns = [ [ {
				field : 'label_id',
				checkbox : true,
				width : 50
			}, {
				field : 'mawb',
				width : 50,
				//sortable : true,
				//sortOrder:'asc',
				title : 'MAWB'
			}, {
				field : 'hawb',
				width : 50,
				//sortable : true,
				//sortOrder:'asc',
				editor:'text',
				title : 'HAWB'
			}, {
				field : 'airport_departure',
				width : 50,
				//sortable : true,
				//sortOrder:'asc',
				title : '起始地'
			}, {
				field : 'destination',
				width : 50,
				//sortable : true,
				//sortOrder:'asc',
				editor:'text',
				title : '目的地'
			}, {
				field : 'total',
				width : 50,
				//sortable : true,
				//sortOrder:'asc',
				title : '件数'
			},{
				field : 'template_name',
				width : 50,
				//sortable : true,
				//sortOrder:'asc',
				editor:'combobox',
				title : '当前模版',
				formatter : function(value, row, index) {
					// 用户没有申请模版权限
					if (opid.length==0) {
						return '无模版权限';
					}
					return value;
			/*
			 * var result1; $.ajax({ url : "/label/template", type : 'POST',
			 * async:false, data:{ opid:JSON.stringify(opid), id:value }, success :
			 * function(result) { result1= eval('(' + result + ')'); } }); return
			 * result1.template_name;
			 */
				}
			},{
				field : 'flight_date',
				width : 50,
				sortable : true,
				sortOrder:'asc',
				title : '航班日期',
				formatter : function(value, row, index) {
					if (value != undefined) {
						return  formatDate(value).split(" ")[0];
					}else {
						return "";
					}
				}
			}, {
				field : 'is_print',
				width : 50,
				title : '状态',
				//sortable : true,
				//sortOrder:'asc',
				formatter : function(value, row, index) {
					if (row.is_print == 1) {
						return "已打印";
					}else if (row.is_print == 2) {
						return "已导出";
					} else {
						return "未打印";
					}
				}
			},{
				field : 'reserve2',
				width : 50,
				//sortable : true,
				//sortOrder:'asc',
				title : '打印时间'
			},{ 
				field : 'update_time', 
				width : 50, 
				sortable : true,
				sortOrder:'asc',
				title : '录入时间', 
				formatter : function(value, row, index) { 
					return formatDate(value); 
				} 
			},{ 
				field : 'opid_name', 
				width : 50, 
				sortable : true,
				sortOrder:'asc',
				title : '录入人'
			},{
				field : 'print_user',
				width : 50,
				//sortable : true,
				//sortOrder:'asc',
				title : '打印人'
			}] ];	
		}else if (type == "medicine") {
			columns = [[
				{field : 'label_id',checkbox : true,width : 50},
		        {field:'MBLNo',title:'运单号',width:100},    
		        {field:'total',editor:'text',title:'打印份数',width:100},    
		        {field:'EDeparture',title:'发货日期',width:100,
		         formatter : function(value, row, index) { 
					return formatDate(value); 
				}},    
		        {field:'SendAddress',title:'发货人信息',width:100},    
		        {field:'RecCustomerName',title:'收货人',width:100},    
		        {field:'RecAddress',title:'收货地址',width:100},    
		        {field:'TakeCargoNo',title:'随货同行单号',width:100},
		        {
					field : 'reserve2',
					width : 50,
					title : '打印时间'
				},
				{
					field : 'print_user',
					width : 50,
					title : '打印人'
				}
			]];
		}
		return columns;
	}
	label.prototype.initLabelDatagrid = function(is_print2) {
		if (is_print2 != undefined) {
			is_print = is_print2;
		}
		var str=encodeURI(encodeURI('/labelPrint/label/all?mawb=' + mawb + '&hawb=' + hawb + '&destination=' + destination + '&total=' + total + '&airport_departure=' + airport_departure + '&is_print=' + is_print + '&start_time=' + start_time+ '&end_time=' + end_time+ '&opid=' + opid1+'&flight_date='+flight_date+'&opid_name='+opid_name+'&businessType='+type+'&MBLNo='+MBLNo+'&TakeCargoNo='+TakeCargoNo));
		$('#dg1').datagrid({
			url : str,
			method : 'POST',
			pagination : true,
			pageSize : 10,
			striped:true,
			scrollbarSize : 0,// 去除右侧空白
			fitColumns : true,
			fit:true,
			pageList : [ 5, 10, 15, 20, 50 ],
			toolbar:'#aa',
			columns : label.columns(),
			rowStyler : function(index, row) {
				if (row.is_print == 1||row.is_print == 2) {
					return 'background-color:#5cb85c';
				}
			},
			onUnselect:function(rowIndex, rowData){
				$("#dg1").datagrid('endEdit', rowIndex);
			},
			onClickCell:function(rowIndex, field, value){
				if (field=="hawb"||field=="template_name"||field=="destination"||(field=="total"&&type=="medicine")) {
			        var rows = $('#dg1').datagrid('getRows');// 获得所有行
			        var row = rows[rowIndex];// 根据index获得其中一行。
					
					$(this).datagrid('beginEdit', rowIndex);
			        if (type=="air") {
						var ed = $(this).datagrid('getEditor', {index:rowIndex,field:'template_name'});
						$(ed.target[0]).combobox({    
						    valueField:'template_name',  
						    textField:'text'
						});
						// 设置模版下拉框的值
						if (opid.length==0) {
							$(ed.target[0]).combobox('setValue', result1.template_name);
						}else {
							var result1;
							$.ajax({
								url : "/labelPrint/label/getUsertemplate",
								type : 'POST',
								async:false,
								data:{
									opid:JSON.stringify(opid)
								},
								success : function(result) {
									result1= eval('(' + result + ')');
								}
							});
							var data = [];
							for (var i = 0; i < result1.length; i++) {
								data.push({ "text": result1[i].template_name, "template_name": result1[i].template_name });
							}
							$(ed.target[0]).combobox('loadData', data);
							// 设置下拉框选中的值
							var result1;
							$.ajax({
								url : "/labelPrint/label/template",
								type : 'POST',
								async:false,
								data:{
									opid:JSON.stringify(opid),
									id:row.template_name
								},
								success : function(result) {
									result1= eval('(' + result + ')');
								}
							});
							$(ed.target[0]).combobox("select",result1.template_name);
						}
			        }
					var ed = $(this).datagrid('getEditor', {index:rowIndex,field:field});
					$(ed.target[0]).focus();// 获取焦点
					// 失去焦点事件,结束编辑
					$(ed.target[0]).blur(function(){
						// $("#dg1").datagrid('endEdit', rowIndex);
					});
				}
			},
			// 结束编辑事件
			onAfterEdit:function(rowIndex, rowData, changes){
				$.ajax({
					url : "/labelPrint/label/update",
					type : 'POST',
					data:{
						hawb:rowData.hawb,
						template_name:rowData.template_name,
						destination:rowData.destination,
						label_id:rowData.label_id,
						total:rowData.total
					},
					success : function(result) {
						// 更新完成后，刷新当前行
						$("#dg1").datagrid('refreshRow', rowIndex);
					}
				});
			},
			// 取消编辑事件
			onCancelEdit:function(rowIndex, rowData){
			},
			onLoadSuccess: function (data) {
		           if (data.total == 0) {
						$('#dg1').datagrid('appendRow',{
							mawb: '无数据！请更改查询条件，或<a href="#"  onclick="subscribe.initWindow()" style="color:green;"><b>订阅</b></a>主单号...',
						}).datagrid('mergeCells',{
							index: 0,
							field: 'mawb',
							colspan: 12
						}).datagrid('hideColumn','label_id');
						
		           }
			},
			// 在用户双击一行的时候触发
	/*
	 * onDblClickRow : function(rowIndex, rowData) { $('#dd4').dialog({ title : ' ',
	 * width : 400, height : 200, maximized : true, draggable : false, closed :
	 * false, cache : false, modal : true }); $('#template_name').combobox({
	 * valueField:'template_name', height:34, textField:'text' }); var data,json;
	 * 
	 * data = []; for (var i = 0; i < opid[0].length; i++) { data.push({ "text":
	 * opid[0][i].Reportname, "template_name": opid[0][i].Reportid }); }
	 * $("#template_name").combobox("loadData", data);
	 * 
	 * $("#MAWB1").val(rowData.mawb); $("#HAWB1").val(rowData.hawb);
	 * $("#total1").val(rowData.total);
	 * $("#airport_departure1").val(rowData.airport_departure);
	 * $("#destination1").val(rowData.destination);
	 * $("#label_id").val(rowData.label_id);
	 * 
	 * $("#create_time").val(formatDate(rowData.create_time));
	 * $("#reserve2").val(rowData.reserve2); if (rowData.flight_date != undefined ) {
	 * $("#flight_date").val(formatDate(rowData.flight_date)); }else {
	 * $("#flight_date").val(""); } $("#print_user").val(rowData.print_user); var
	 * template_name= rowData.template_name; $.ajax({ url : "/label/template", type :
	 * 'POST', async:false, data:{ opid:JSON.stringify(opid), id:template_name },
	 * success : function(result) { result= eval('(' + result + ')');
	 * $('#template_name').combobox("select",result.template_name); } });
	 * 
	 * if (rowData.is_print == 1) { $("#is_print1").val("已打印"); } else {
	 * $("#is_print1").val("未打印"); } }
	 */
		});
	}
	var label = new label();
	
	
	
	function subscribe() {

	}
	var mawb;
	var hawb;
	var srEmail;
	var srUser;
	var srOpid;
	subscribe.prototype.clearForm = function() {
		$("#srHawb").val("");
		$("#srMawb").val("");
		label.refresh(false);
	}
	/**
	 * 用户点击订阅按钮
	 */
	subscribe.prototype.initWindow = function() {
		subscribe.initDataGrid();
		$('#subscribeDialog').dialog({
			title : ' ',
			width : "70%",
			height : '50%',
			shadow : true,
			border : 'thick',
			maximizable : true,
			closed : false,
			cache : false,
			constrain : true,
			modal : true,
			onClose : function() {
				$("#srMawb").val("");
				$("#srHawb").val("");
				label.refresh(false);
			}
		});
		// 从搜索框获取主单号、分单号
		mawb = $("#srMawb").val() == '' ? $("#mawb").val() : $("#srMawb").val();
		hawb = $("#srHawb").val() == '' ? $("#hawb").val() : $("#srHawb").val();

		srEmail = $("#srEmail").val();
		srUser = $("#srUser").val();
		srOpid = $("#srOpid").val();

		$("#srMawb").val(mawb);
		$("#srHawb").val(hawb);
	}
	subscribe.prototype.initDataGrid = function() {
		$('#srDg').datagrid({
			url : '../../labelPrint/subscribe/all',
			method : 'POST',
			pagination : true,
			pageSize : 5,
			striped : true,
			scrollbarSize : 0,// 去除右侧空白
			fitColumns : true,
			fit : true,
			pageList : [ 5, 10, 15, 20, 50 ],
			toolbar : '#sr',
			columns : [ [ {
				field : 'srMawb',
				width : 50,
				title : 'MAWB'
			}, {
				field : 'srHawb',
				width : 50,
				title : 'HAWB'
			}, {
				field : 'srUser',
				width : 50,
				title : '订阅人'
			}, {
				field : 'srEmail',
				width : 50,
				title : 'Email'
			}, {
				field : 'srState',
				width : 50,
				title : '订阅状态',
				formatter : function(value, row, index) {
					if (value == '1') {
						return "订阅完成"
					} else {
						return "<b style='color:green;'>订阅中</b>"
					}
				}
			} ] ],
			onClickCell : function(rowIndex, field, value) {
			},
			// 在用户双击一行的时候触发
			onDblClickRow : function(rowIndex, rowData) {
			}
		});
	}
	/**
	 * 用户点击订阅，提交表单
	 */
	subscribe.prototype.submitForm = function() {
		mawb = $("#srMawb").val() == '' ? $("#mawb").val() : $("#srMawb").val();
		hawb = $("#srHawb").val() == '' ? $("#hawb").val() : $("#srHawb").val();
		$.ajax({
			url : "/labelPrint/subscribe/add",
			type : 'POST',
			async : true,
			data : {
				srEmail : srEmail,
				srUser : srUser,
				srMawb : mawb,
				srOpid : srOpid,
				srHawb : hawb
			},
			success : function(result) {
				if (result == "true") {
					$.messager.show({
						title : '<b style="font-size:12;text-align:center;">我的消息</b>',
						msg : '<h3 style="color:green;text-align:center;">订阅成功</h3>',
						timeout : 3000,
						showType : 'fade'
					});
					$('#srDg').datagrid("reload");
				} else if (result == "false") {
					$.messager.show({
						title : '<b style="font-size:12;text-align:center;">我的消息</b>',
						msg : '<h3 style="color:red;text-align:center;">订阅失败,请稍后重试</h3>',
						timeout : 3000,
						showType : 'fade'
					});
				} else {
					$.messager.alert({
						title : '订阅失败',
						width : 500,
						headerCls : 'jz',
						bodyCls : 'jz',
						msg : result
					});
				}
			}
		});

	}
	var subscribe = new subscribe();
	</script>
</body>